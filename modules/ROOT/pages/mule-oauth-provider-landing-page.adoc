= Mule OAuth 2.0 Provider
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:meta-audience: Developer
:meta-job-phase: Implement
:meta-job:
:meta-exp-level: Expert
:meta-feature: oauth
:meta-keywords: oauth, oauth provider, authentication
:meta-synonym:
:meta-product: API Manager, Studio, Mule
:meta-applies-to:

The Mule OAuth 2.0 Provider, developed by Mulesoft, is an alternative for the OAuth 2.0, and can be used in any API Platform organization, including the Federated ones. The Mule OAuth 2.0 provider is the first-step solution for your OAuth 2.0 offerings.

You must deploy the Mule OAuth 2.0 provider to a runtime with API gateway capabilities, for example, Mule runtime engine (Mule) 3.x, 4.2.0, or later, with the corresponding organization credentials. The following third party OAuth 2.0 providers are supported:

* PingFederate
* OpenAM
* OAuth 2.0 providers supporting Open ID Connect

The xref:external-oauth-2.0-token-validation-policy.adoc[Mule OAuth 2.0 access token enforcement policy] is designed to work with the Mule OAuth 2.0 provider.

== Downloading the Mule OAuth 2.0 Provider

You can download the Mule OAuth 2.0 provider from Anypoint Exchange:

* Mule 3.x: See the https://anypoint.mulesoft.com/exchange/org.mule.templates/api-gateway-external-oauth2-provider/[External OAuth 2.0 server for Anypoint Platform].
* Mule 4.x: See the https://anypoint.mulesoft.com/exchange/org.mule.templates/api-gateway-oauth2-provider/[Mule OAuth 2.0 server for Anypoint Platform].
+
This feature is availble from Mule 4.2.0.

== OAuth 2.0 dance

The authentication performed by the Mule OAuth 2.0 provider, API, and client application conforms to RFC 6749. This authentication process is known as the xref:oauth-dance-about.adoc[OAuth 2.0 dance]. 

Mule OAuth 2.0 provider supports all xref:oauth-grant-types-about.adoc[grant types]. The entity that requests access to a resource protected by Mule OAuth 2.0 access token enforcement policy is a `Client`.

=== Endpoints

The Mule OAuth 2.0 provider has the following endpoints that you can call in your API implementation:

image::mule-oauth-provider.png[height=150,width=250]

[%header%autowidth.spread,cols="a,a,a"]
|===
| Purpose | Default path | Description
| Token validation
| /validate
| Used to verify the validity of the token, whether the token is expired, revoked or fake. You can define more than one validation endpoint, each of them enforcing different scopes. For more information, see <<Scopes>>.
| Authorization
| /authorize
| Used to obtain a token when the client is running in a browser using a scripting language, or the client is a web server.
| Access
| /access_token
| Used when the client is owned by the same entity as the Mule OAuth 2.0 provider or when the client is the same entity as the protected resource owner.
| Token revocation
| /revoke
| [Optional] Used to revoke a valid token to render it invalid.
|===

=== Implementing Scopes 

The OAuth 2.0 https://tools.ietf.org/html/rfc6749#page-23[scopes] enable you to further limit access to a resource protected by OAuth. You can define words, such as, `READ` and `WRITE`, or others specific to your organization, such as, `CONTRACTOR`, `PUBLIC`, `EMPLOYEES_ONLY`, and so on.

You can define scopes in three different places:

* In the universal set definition, `defaultScopes`, where you define all possible scopes.
Example:
+
[source,xml,linenums]
----
<oauth2-provider:config
  scopes="CONTRACTOR, PUBLIC_READ, EMPLOYEES_ONLY, WRITE"
  >
  ...
</oauth2-provider:config>
----
* In the `/validate` validation endpoint, to enforce a particular subset of the previously defined scopes.
* In the Mule OAuth 2.0 Access Token Enforcement policy, where you can enforce scopes by specifying a space-separated list.
+
Specifying more than one scope enforces the `OR` logic. If the token to be validated has associated at least one of the requested scopes, the policy validates the token successfully.

Example of using scopes in Mule 4.2.x or later:

[source,xml,linenums]
----
...
    <oauth2-provider:config name="external-oauth2-provider"
    							resourceOwnerSecurityProvider="resourceOwnerSecurityProvider"
    							clientSecurityProvider="clientSecurityProvider"
    							supportedGrantTypes="AUTHORIZATION_CODE,IMPLICIT,RESOURCE_OWNER_PASSWORD_CREDENTIALS,CLIENT_CREDENTIALS"
    							listenerConfig="https.listener"
    							scopes="CONTRACTOR, PUBLIC_READ, EMPLOYEES_ONLY, WRITE"
                                defaultScopes="CONTRACTOR, PUBLIC_READ, EMPLOYEES_ONLY, WRITE"
                                clientStore="clientObjectStore">
    		<oauth2-provider:token-config path="/access-token" tokenTtl="5" tokenTtlTimeUnit="SECONDS" tokenStore="tokenObjectStore">
                <oauth2-provider:refresh-token-strategy>
                    <oauth2-provider:single-refresh-token objectStore="refreshTokenObjectStore"/>
                </oauth2-provider:refresh-token-strategy>
            </oauth2-provider:token-config>
    		<oauth2-provider:authorization-config path="/authorize" authorizationCodeStore="authorizationCodeObjectStore"/>
    	</oauth2-provider:config>

        <flow name="validateToken">
            <http:listener path="/validate" config-ref="https.listener"/>
            <oauth2-provider:validate-token scopes="#[['PUBLIC_READ']]" config-ref="external-oauth2-provider" accessToken="#[attributes.queryParams.access_token]"/>
            <error-handler>
                <on-error-continue type="OAUTH2-PROVIDER:TOKEN_UNAUTHORIZED">
                    <set-payload value="UNAUTHORIZED_TOKEN"/>
                </on-error-continue>
            </error-handler>
        </flow>
...
----

For complete information, see https://anypoint.mulesoft.com/exchange/org.mule.templates/api-gateway-oauth2-provider/[Mule OAuth 2.0 server for Anypoint Platform].

== Client Application Cache

To prevent any possible downtime of the Mule OAuth 2.0 provider due to errors when connecting to Anypoint Platform, the Mule OAuth Client Store caches each valid Client Application for which a token is requested.

In the rare instance that the provider requests a new token when there is no connection available, the client store falls back to cache. The entries expire in 30 days, which is the default setting. To ensure service availability in case of a restart or lack of connection to Anypoint Platform, you can configure this range to persist the cache locally.

In case a client application for which a token already exists in the client store is removed from Anypoint Platform,
the client store removes the client from the cache on the next token request, mirroring the platform status. The mechanism that caches the result of a successful token validation is part of the xref:external-oauth-2.0-token-validation-policy.adoc[Mule OAuth 2.0 access token enforcement policy].

=== Customizing the Client Application Cache Mechanism

The customization of the default values of the cache mechanism is outlined in this section. This feature is available for Mule 4.2.0 and later.

The Object Store has two configurable properties:
[%header%autowidth.spread,cols="a,a"]
|===
| `anypoint.oauth_provider.cache_persistence_enabled`
| Defines whether the caching mechanism should persist locally. The default value is `true` if the property is not set or cannot be parsed. Cache persistence allows client authorization without connection to Anypoint Platform.

| `anypoint.oauth_provider.cache_ttl_days`
| Represents how many days each Client Application should be cached by the OAuth Server. This value can be any positive floating point number. The default value is `30`, representing 30 days.
|===

== See Also

*** xref:external-oauth-2.0-token-validation-policy.adoc[Mule OAuth 2.0 Access Token Policy usage]
*** xref:oauth-dance-about.adoc[OAuth 2.0 Dance and OAuth 2.0 Access Token Enforcement]
*** xref:oauth-grant-types-about.adoc[OAuth 2.0 Grant Types]
*** xref:org-credentials-config-mule4.adoc[Setting startup credentials]
