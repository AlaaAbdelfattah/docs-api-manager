= Configuring API Autodiscovery in a Mule 4 Application
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

To configure API Autodiscovery in your Mule 4.x application, make sure the API is available in API Manager, that the Runtime is configured with the platform/environment credentials, and the the application's autodiscovery element is filled correctly. Follow the below sections accordingly.

== Make your API Available in API Manager

The API you want to pair your Mule application to must be available in API Manager.

You can either:

* Publish your API in Exchange and import it from there to API Manager. See xref:manage-exchange-api-task.adoc[To Manage an API from Exchange], or
* Import it directly from your machine. See xref:import-api-task.adoc[To Import an API Instance] for more details.

API ID is required by the Autodiscovery element to identify the API to which you want to pair your application. API Manager generates an "API ID" identifier for every imported API:

image::api-id.png[align=center]

== Configure API Manager

Configure API Manager to use the deployed Mule application as the API proxy.

. For Managing type, select Basic Endpoint.
. Add the Implementation URI that points to the deployed Mule application.
. Select the "Mule 4 or above" checkbox: `Check this box if you are managing this API in Mule 4 or above`.

=== Getting Environment Client ID and Secret

In Anypoint Platform, log in as an administrator. Go to Access Management, then click Environments, and toggle to the environment where your API is managed.

The environment client ID and secret are shown:

image::environment-api-manager.png[align=center]

=== Getting Organization Information

If using organization information instead of environment client ID and secret, log into Anypoint Platform as administrator, click Access Management, Organization, and click your target organization name.

The organization info appears:

image::orgid-api-manager.png[align=center]


== Configure Anypoint Platform Credentials in Mule Runtime

Configure the platform or environment credentials in Mule standalone, from Runtime Manager, or from Anypoint Studio. 

=== Standalone Installation

. Navigate to your $MULE_HOME directory.
. Open the file located in  `/conf/wrapper.conf`
. Add your Anypoint Platform Organization credentials in these configurations:
+
[source,text,linenums]
----
wrapper.java.additional.<n>=-Danypoint.platform.client_id=XXXXXXXX
wrapper.java.additional.<n>=-Danypoint.platform.client_secret=XXXXXXXX
----
+
In these arguments you can pass both organization, or environment credentials.

=== Runtime Manager for your Deployed Application

. Navigate to Runtime Manager in Anypoint Platform.
. Access the Properties section of the deployed application. If the application is being deployed for the first time, the Properties section will appear during the deployment configuration.
. In the Properties section, add the following properties:
+
[source,text,linenums]
----
anypoint.platform.client_id=XXXXXXXX
anypoint.platform.client_secret=XXXXXXXX
----

=== Anypoint Studio 7

You can also pass these credentials in Anypoint Studio 7:

. In Anypoint Studio, click Anypoint Studio from the top menu bar, and Preferences.
. Under Anypoint Studio, click API Manager
. Type in the client ID and secret under Environment Credentials
+
image::configure-autodiscovert-4-studio.png[align=center]

== Configure the Autodiscovery Element in Your Mule Application

In the code of your Mule Application configure the `api-gateway:Autodiscovery` element. The Autodiscovery element points to the specific API in API Manager you want it to pair to.

After the element is defined in the application, and the runtime is configured with your Anypoint Platform credentials, Mule Runtime will automatically track and keep up to date with the API configuration defined in API Manager.

<1> Configure the `apiId` with the API ID that API Manager assigned to your API.
<2> Set the `flowRef` element to point to the flow that you want to pair to the API in API Manager.

.XML element
[source,xml,linenums]
----
<api-gateway:autodiscovery
  apiId="${apiId}" // <1>
  flowRef="myFlow" /> // <2>
----

[TIP]
If you configured a proxy endpoint for your API, your autogenerated proxy will already be correctly configured with the Autodiscovery element.

=== Configure Autodiscovery Element Using Properties

You can create a `config.properties` file where you define `${apiId}` in a key-value fashion: `apiId=[your-specific-value]` and reference it as `${apiId}` in this configuration.

=== Configure Autodiscovery Element Using Studio UI

Within Studio you can configure a global element for the app the reference.

. In your existing flow, select the Global Elements tab in your Mule Configuration File editor.
. Click the Create button, and look for the API Autodiscovery global element.
+
image::auto-discovery-studio-7.png[align=center]
. Set the API ID and Flow Reference. +
+
image::auto-discovery-api-config.png[align=center]


//_COMBAK: Does this need to be deployed for the green dot to show in API Manager?

== Changes from Mule 3.x Configuration

API Autodiscovery element syntax changed from Mule 3.x. See the changes:

[%header%autowidth.spread,cols="a,a"]
|===
^| Mule 3.x XML element ^| Mule 4.x XML element
^| <api-platform-gw:api (...)/>. ^| <api-gateway:autodiscovery (...)/>.
|===

In Mule 4, the API is identified by the API ID and a reference to a Flow where the HTTP listener is defined. Mule 4â€™s `apiId` replaces the `apiName` and `apiVersion` used to specify the Autodiscovery element in Mule 3.x and prior.

== See Also

* xref:api-auto-discovery-new-concept.adoc[About API Autodiscovery]
